<graph id="S3_proc">
  <version>1.0</version>

  <!-- convert raw S3 EFR to Albedo -->
  <node id="OLCI.SnowAlbedo">
    <operator>OLCI.SnowAlbedo</operator>
    <sources>
      <sourceProduct>${source}</sourceProduct>
    </sources>
    <parameters>
      <copyReflectanceBands>false</copyReflectanceBands>
    </parameters>
  </node>
  
  <!--
      same as above, but to Reflectance. We don't use the
      "copyReflectanceBands feature above because it didn't seem to
      produce all of them.
  -->
  <node id="Rad2Refl">
    <operator>Rad2Refl</operator>
    <sources>
      <source>${source}</source>
    </sources>
    <parameters>
      <sensor>OLCI</sensor>
      <copyTiePointGrids>true</copyTiePointGrids>
      <copyFlagBandsAndMasks>true</copyFlagBandsAndMasks>
      <copyNonSpectralBands>true</copyNonSpectralBands>
    </parameters>
  </node>

  <!-- reproject BOTH Albedo and Reflectance -->
  <node id="ReprojectAlbedo">
    <operator>Reproject</operator>
    <sources>
      <source>OLCI.SnowAlbedo</source>
    </sources>
    <parameters>
      <crs>EPSG:3413</crs>
      <resampling>Nearest</resampling>
      <noDataValue>NaN</noDataValue>
      <includeTiePointGrids>false</includeTiePointGrids>
      <!-- we'll access TiePointGrids from the Rad2Refl reprojected product -->
    </parameters>
  </node>
  <node id="Reproject">
    <operator>Reproject</operator>
    <sources>
      <source>Rad2Refl</source>
    </sources>
    <parameters>
      <crs>EPSG:3413</crs>
      <resampling>Nearest</resampling>
      <noDataValue>NaN</noDataValue>
      <includeTiePointGrids>true</includeTiePointGrids>
    </parameters>
  </node>

  <!--
      from here down, pairs:
      1) Select a band (from albedo or reflectance) and
      2) write to disk
  -->
  <node id="BandSelect_albedo_spherical_400">
    <operator>BandSelect</operator>
    <sources>
      <source>ReprojectAlbedo</source>
    </sources>
    <parameters>
      <sourceBands>albedo_spectral_spherical_400</sourceBands>
    </parameters>
  </node>
  <node id="Write_spherical_400">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_albedo_spherical_400</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/albedo_spectral_spherical_0400.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>

  <node id="BandSelect_albedo_spherical_560">
    <operator>BandSelect</operator>
    <sources>
      <source>ReprojectAlbedo</source>
    </sources>
    <parameters>
      <sourceBands>albedo_spectral_spherical_560</sourceBands>
    </parameters>
  </node>
  <node id="Write_albedo_spherical_560">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_albedo_spherical_560</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/albedo_spectral_spherical_0560.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>
  
  <node id="BandSelect_albedo_spherical_665">
    <operator>BandSelect</operator>
    <sources>
      <source>ReprojectAlbedo</source>
    </sources>
    <parameters>
      <sourceBands>albedo_spectral_spherical_665</sourceBands>
    </parameters>
  </node>
  <node id="Write_albedo_spherical_665">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_albedo_spherical_665</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/albedo_spectral_spherical_0665.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>
  
  <node id="BandSelect_albedo_spherical_865">
    <operator>BandSelect</operator>
    <sources>
      <source>ReprojectAlbedo</source>
    </sources>
    <parameters>
      <sourceBands>albedo_spectral_spherical_865</sourceBands>
    </parameters>
  </node>
  <node id="Write_albedo_spherical_865">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_albedo_spherical_865</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/albedo_spectral_spherical_0865.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>
  
  <node id="BandSelect_albedo_spherical_1020">
    <operator>BandSelect</operator>
    <sources>
      <source>ReprojectAlbedo</source>
    </sources>
    <parameters>
      <sourceBands>albedo_spectral_spherical_1020</sourceBands>
    </parameters>
  </node>
  <node id="Write_albedo_spherical_1020">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_albedo_spherical_1020</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/albedo_spectral_spherical_1020.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>

  <node id="BandSelect_albedo_broadband_spherical">
    <operator>BandSelect</operator>
    <sources>
      <source>ReprojectAlbedo</source>
    </sources>
    <parameters>
      <sourceBands>albedo_broadband_spherical</sourceBands>
    </parameters>
  </node>
  <node id="Write_albedo_broadband_spherical">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_albedo_broadband_spherical</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/albedo_broadband_spherical.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>


  <!-- planar -->
  <node id="BandSelect_albedo_planar_400">
    <operator>BandSelect</operator>
    <sources>
      <source>ReprojectAlbedo</source>
    </sources>
    <parameters>
      <sourceBands>albedo_spectral_planar_400</sourceBands>
    </parameters>
  </node>
  <node id="Write_planar_400">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_albedo_planar_400</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/albedo_spectral_planar_0400.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>

  <node id="BandSelect_albedo_planar_560">
    <operator>BandSelect</operator>
    <sources>
      <source>ReprojectAlbedo</source>
    </sources>
    <parameters>
      <sourceBands>albedo_spectral_planar_560</sourceBands>
    </parameters>
  </node>
  <node id="Write_albedo_planar_560">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_albedo_planar_560</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/albedo_spectral_planar_0560.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>
  
  <node id="BandSelect_albedo_planar_665">
    <operator>BandSelect</operator>
    <sources>
      <source>ReprojectAlbedo</source>
    </sources>
    <parameters>
      <sourceBands>albedo_spectral_planar_665</sourceBands>
    </parameters>
  </node>
  <node id="Write_albedo_planar_665">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_albedo_planar_665</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/albedo_spectral_planar_0665.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>
  
  <node id="BandSelect_albedo_planar_865">
    <operator>BandSelect</operator>
    <sources>
      <source>ReprojectAlbedo</source>
    </sources>
    <parameters>
      <sourceBands>albedo_spectral_planar_865</sourceBands>
    </parameters>
  </node>
  <node id="Write_albedo_planar_865">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_albedo_planar_865</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/albedo_spectral_planar_0865.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>
  
  <node id="BandSelect_albedo_planar_1020">
    <operator>BandSelect</operator>
    <sources>
      <source>ReprojectAlbedo</source>
    </sources>
    <parameters>
      <sourceBands>albedo_spectral_planar_1020</sourceBands>
    </parameters>
  </node>
  <node id="Write_albedo_planar_1020">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_albedo_planar_1020</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/albedo_spectral_planar_1020.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>

  <node id="BandSelect_albedo_broadband_planar">
    <operator>BandSelect</operator>
    <sources>
      <source>ReprojectAlbedo</source>
    </sources>
    <parameters>
      <sourceBands>albedo_broadband_planar</sourceBands>
    </parameters>
  </node>
  <node id="Write_albedo_broadband_planar">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_albedo_broadband_planar</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/albedo_broadband_planar.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>


  <!-- reflectance -->
  <node id="BandSelect_01">
    <operator>BandSelect</operator>
    <sources>
      <source>Reproject</source>
    </sources>
    <parameters>
      <sourceBands>Oa01_reflectance</sourceBands>
    </parameters>
  </node>
  <node id="Write_01">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_01</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/Oa01_reflectance.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>
  
  <node id="BandSelect_04">
    <operator>BandSelect</operator>
    <sources>
      <source>Reproject</source>
    </sources>
    <parameters>
      <sourceBands>Oa04_reflectance</sourceBands>
    </parameters>
  </node>
  <node id="Write_04">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_04</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/Oa04_reflectance.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>
  
  <node id="BandSelect_06">
    <operator>BandSelect</operator>
    <sources>
      <source>Reproject</source>
    </sources>
    <parameters>
      <sourceBands>Oa06_reflectance</sourceBands>
    </parameters>
  </node>
  <node id="Write_06">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_06</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/Oa06_reflectance.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>

  <node id="BandSelect_08">
    <operator>BandSelect</operator>
    <sources>
      <source>Reproject</source>
    </sources>
    <parameters>
      <sourceBands>Oa08_reflectance</sourceBands>
    </parameters>
  </node>
  <node id="Write_08">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_08</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/Oa08_reflectance.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>

  <node id="BandSelect_14">
    <operator>BandSelect</operator>
    <sources>
      <source>Reproject</source>
    </sources>
    <parameters>
      <sourceBands>Oa14_reflectance</sourceBands>
    </parameters>
  </node>
  <node id="Write_14">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_14</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/Oa14_reflectance.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>

  <node id="BandSelect_15">
    <operator>BandSelect</operator>
    <sources>
      <source>Reproject</source>
    </sources>
    <parameters>
      <sourceBands>Oa15_reflectance</sourceBands>
    </parameters>
  </node>
  <node id="Write_15">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_15</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/Oa15_reflectance.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>
  
  <node id="BandSelect_17">
    <operator>BandSelect</operator>
    <sources>
      <source>Reproject</source>
    </sources>
    <parameters>
      <sourceBands>Oa17_reflectance</sourceBands>
    </parameters>
  </node>
  <node id="Write_17">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_17</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/Oa17_reflectance.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>

  <node id="BandSelect_21">
    <operator>BandSelect</operator>
    <sources>
      <source>Reproject</source>
    </sources>
    <parameters>
      <sourceBands>Oa21_reflectance</sourceBands>
    </parameters>
  </node>
  <node id="Write_21">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_21</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/Oa21_reflectance.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>

  <!-- orbital parameters -->
  <!--
      Radiance bands have NoData stripes.
      SZA does not.
      Make SZA data invald where there is no Radiance data
  -->
  <node id="SZA_invalid">
    <operator>BandMaths</operator>
    <sources>
      <sourceProducts>Reproject</sourceProducts>
    </sources>
    <parameters>
      <targetBands>
        <targetBand>
          <name>sun_zenith</name>
          <type>float32</type>
          <expression>quality_flags.invalid ? NaN : SZA</expression>
        </targetBand>
      </targetBands>
    </parameters>
  </node>

  <node id="BandSelect_SZA">
    <operator>BandSelect</operator>
    <sources>
      <source>SZA_invalid</source>
    </sources>
    <parameters>
      <sourceBands>sun_zenith</sourceBands>
    </parameters>
  </node>
  <node id="Write_SZA">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_SZA</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/SZA.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>
  
  <node id="BandSelect_OZA">
    <operator>BandSelect</operator>
    <sources>
      <source>Reproject</source>
    </sources>
    <parameters>
      <sourceBands>OZA</sourceBands>
    </parameters>
  </node>
  <node id="Write_OZA">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_OZA</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/OZA.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>

  <node id="BandSelect_SAA">
    <operator>BandSelect</operator>
    <sources>
      <source>Reproject</source>
    </sources>
    <parameters>
      <sourceBands>SAA</sourceBands>
    </parameters>
  </node>
  <node id="Write_SAA">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_SAA</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/SAA.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>

  <node id="BandSelect_OAA">
    <operator>BandSelect</operator>
    <sources>
      <source>Reproject</source>
    </sources>
    <parameters>
      <sourceBands>OAA</sourceBands>
    </parameters>
  </node>
  <node id="Write_OAA">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_OAA</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/OAA.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>
  
  <node id="BandSelect_lon">
    <operator>BandSelect</operator>
    <sources>
      <source>Reproject</source>
    </sources>
    <parameters>
      <sourceBands>longitude</sourceBands>
    </parameters>
  </node>
  <node id="Write_lon">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_lon</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/lon.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>

  <node id="BandSelect_lat">
    <operator>BandSelect</operator>
    <sources>
      <source>Reproject</source>
    </sources>
    <parameters>
      <sourceBands>latitude</sourceBands>
    </parameters>
  </node>
  <node id="Write_lat">
    <operator>Write</operator>
    <sources>
      <sourceProduct>BandSelect_lat</sourceProduct>
    </sources>
    <parameters>
      <file>${targetFolder}/lat.tif</file>
      <formatName>GeoTIFF</formatName>
    </parameters>
  </node>

</graph>
